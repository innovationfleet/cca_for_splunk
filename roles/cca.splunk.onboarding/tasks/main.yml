---
# tasks file for cca.splunk.onboarding
#
# Description:
#
# Prerequisite:
#
# Author: Roger Lindquist (github.com/rlinq)
#
# Release: 2025.3.1.1

# tasks file for cca.splunk.onboarding

- name: Set variable for selected_apps source path
  ansible.builtin.set_fact:
    selected_apps_source_path: '{{ selected_apps_absolute_sourcedir | default(absolute_file_store_path + "/etc/" + selected_apps_sourcedir) }}'

- name: Set variable for versioned_apps source path
  ansible.builtin.set_fact:
    versioned_apps_source_path: '{{ versioned_apps_absolute_sourcedir | default(absolute_file_store_path + "/etc/" + versioned_apps_sourcedir) }}'

- name: Ensure local tmp directory exists
  become: false
  delegate_to: localhost
  connection: local
  ansible.builtin.file:
    path: "{{ cca_local_tmp_dir | default('/tmp/cca_tmp') }}"
    state: directory
    mode: '0700'
  check_mode: false

- name: Include task for shcluster app staging
  ansible.builtin.include_tasks: stage_shcluster_apps.yml
  when:
    - shcluster_label is defined
    - deploy_scope | default('') == "shcluster_apps"

- name: Include task for shcluster app deployment
  ansible.builtin.include_tasks: deploy_shcluster_apps.yml
  when:
    - shcluster_label is defined
    - deploy_scope | default('') == "shcluster_apps"

- name: Include task to check cluster status
  ansible.builtin.include_role:
    name: cca.core.splunk
    tasks_from: cluster/get_cluster_status.yml
  when:
    - cluster_label is defined
    - deploy_scope | default('') == "manager-apps"

- name: Check and fail if cluster is not preflight ready
  block:
    - name: Normalize preflight output
      ansible.builtin.set_fact:
        pf_stdout_lines: >-
          {{ (verbose_cluster_status.stdout | default('') | replace('\\r\\n', '\n') | replace('\\n', '\n')) | split('\n') }}
        pf_stderr_lines: >-
          {{ (verbose_cluster_status.stderr | default('') | replace('\\r\\n', '\n') | replace('\\n', '\n')) | split('\n') }}
      no_log: true
      when:
        - not skip_deployment_preflight_check | default(false)
        - cluster_label is defined
        - deploy_scope | default('') == "manager-apps"

    - name: Check and fail if cluster is not preflight ready (short message)
      ansible.builtin.assert:
        that:
          - cluster_preflight_status_flag | default(false)
        fail_msg: >-
          Preflight failed.
          Showing a short summary; detailed stdout/stderr will follow below.
      when:
        - not skip_deployment_preflight_check | default(false)
        - cluster_label is defined
        - deploy_scope | default('') == "manager-apps"

  rescue:
    - name: Detailed preflight output (only printed on failure)
      ansible.builtin.debug:
        msg: |
          === stdout (first 200 lines) ===
          {{ (pf_stdout_lines[:200] | join('\n')) if pf_stdout_lines | length > 0 else '<<no stdout>>' }}

          === stderr (first 100 lines) ===
          {{ (pf_stderr_lines[:100] | join('\n')) if pf_stderr_lines | length > 0 else '<<no stderr>>' }}

    - name: Stop play after showing details
      ansible.builtin.fail:
        msg: "Preflight failed â€” see detailed output above."

- name: Include task for master apps staging
  ansible.builtin.include_tasks: stage_manager_apps.yml
  when:
    - cluster_label is defined
    - deploy_scope | default('') == "manager-apps"

- name: Include task for master apps deployment
  ansible.builtin.include_tasks: deploy_manager_apps.yml
  when:
    - cluster_label is defined
    - deploy_scope | default('') == "manager-apps"

- name: Include task for apps deployment to splunk instance
  ansible.builtin.include_tasks: deploy_apps.yml
  when:
    - deploy_scope | default('') == "apps"

- name: Include task for deployment apps staging
  ansible.builtin.include_tasks: stage_deployment_apps.yml
  when:
    - deploy_scope | default('') == "deployment-apps"

- name: Include task for DRY RUN serverclass apps deployment to splunk deployment servers
  ansible.builtin.include_tasks: dry_run_deployment_apps.yml
  when:
    - deploy_scope | default('') == "deployment-apps"

- name: Include task for serverclass apps deployment to splunk deployment servers
  ansible.builtin.include_tasks: deploy_deployment_apps.yml
  when:
    - deploy_scope | default('') == "deployment-apps"

- name: Cleanup onboarding staging directory
  delegate_to: localhost
  connection: local
  become: false
  ansible.builtin.file:
    path: "{{ (cca_local_tmp_dir | default('/tmp/cca_tmp')) }}/{{ cca_runid }}/{{ environment_name }}"
    state: absent
  changed_when: false
  failed_when: false
  when:
    - hide_password | default(true)
