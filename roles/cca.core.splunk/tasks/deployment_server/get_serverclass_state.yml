---
# tasks file for cca.core.splunk
#
# Description:
#
# Prerequisite:
#
# Author: Roger Lindquist (github.com/rlinq)
#
# Release: 2025.3.2


- name: Set fact for ds inventory name
  ansible.builtin.set_fact:
    ds_inventory_hostname: "{{ inventory_hostname }}"
  delegate_to: localhost
  delegate_facts: true

- name: Set fact for local and remote dir
  ansible.builtin.set_fact:
    remote_directory: "{{ splunk_path }}/etc/apps"
    local_directory: >
      {{ deployment_servers_apps_sourcedir | default(absolute_onboarding_repo_path + '/splunk/etc/apps/deployment_servers/' + environment_name) }}

- name: Ensure the bin directory exists on the remote host
  ansible.builtin.file:
    path: "{{ (cca_remote_tmp_dir | default('/tmp')) }}/bin"
    state: directory
    mode: '0755'
  changed_when: false
  check_mode: false

- name: Ensure unique directories exist on localhost
  delegate_to: localhost
  connection: local
  become: false
  ansible.builtin.file:
    path: "{{ (cca_local_tmp_dir | default('/tmp/cca_tmp')) }}/{{ cca_runid }}/{{ environment_name }}/{{ inventory_hostname }}/{{ hostvars['localhost']['ds_inventory_hostname'] }}"
    state: directory
    mode: '0755'
  changed_when: false
  check_mode: false

- name: Copy sc_parser.py to remote host
  ansible.builtin.copy:
    src: "{{ role_path }}/files/bin/sc_parser.py"
    dest: "{{ (cca_remote_tmp_dir | default('/tmp')) }}/bin/sc_parser.py"
    mode: '0755'
  changed_when: false
  check_mode: false

- name: Copy compare_serverclass_data.py to localhost
  connection: local
  become: false
  ansible.builtin.copy:
    src: "{{ role_path }}/files/bin/compare_serverclass_data.py"
    dest: "{{ (cca_local_tmp_dir | default('/tmp/cca_tmp')) }}/{{ cca_runid }}/{{ environment_name }}/compare_serverclass_data.py"
    mode: '0755'
  delegate_to: localhost
  changed_when: false
  check_mode: false

- name: Ensure directory for output files on localhost
  connection: local
  become: false
  ansible.builtin.file:
    path: "{{ (cca_local_tmp_dir | default('/tmp/cca_tmp')) }}/{{ cca_runid }}/{{ environment_name }}/localhost/{{ inventory_hostname }}"
    state: 'directory'
    mode: '0755'
    recurse: true
  delegate_to: localhost
  changed_when: false
  check_mode: false

- name: Ensure directory for output files on remote host
  ansible.builtin.file:
    path: "{{ [cca_remote_tmp_dir | default('/tmp'),
               cca_runid, environment_name,
               hostvars['localhost']['ds_inventory_hostname']] | path_join }}"
    state: 'directory'
    mode: '0755'
    recurse: true
  changed_when: false
  check_mode: false

- name: Run sc_parser.py on localhost
  connection: local
  become: false
  ansible.builtin.command: >
    {{ ansible_python_interpreter }} {{ role_path }}/files/bin/sc_parser.py
    {{ local_directory }}
    {{ [cca_local_tmp_dir | default('/tmp/cca_tmp'), cca_runid, environment_name, 'localhost', inventory_hostname, 'serverclass_data_local.json'] | path_join }}
    {{ [cca_local_tmp_dir | default('/tmp/cca_tmp'), cca_runid, environment_name, 'localhost', inventory_hostname, 'duplicates_data_local.json'] | path_join }}
    {{ [cca_local_tmp_dir | default('/tmp/cca_tmp'), cca_runid, environment_name, 'localhost', inventory_hostname] | path_join }}
  delegate_to: localhost
  register: local_result
  changed_when: false
  check_mode: false

- name: Read duplicates data
  connection: local
  become: false
  delegate_to: localhost
  ansible.builtin.slurp:
    src: "{{ (cca_local_tmp_dir | default('/tmp/cca_tmp')) }}/{{ cca_runid }}/{{ environment_name }}/localhost/{{ inventory_hostname }}/duplicates_data_local.json"
  register: duplicates_data

- name: Check if duplicates data is present
  ansible.builtin.set_fact:
    duplicates_present: "{{ duplicates_data.content | b64decode | from_json }}"

- name: Fail if duplicates data is present
  ansible.builtin.fail:
    msg: "There are duplicate entries in the serverclass data: {{ duplicates_present | to_nice_json }}"
  when: >
    duplicates_present.duplicate_keys | length > 0 or
    duplicates_present.duplicate_sections | length > 0

- name: Set deployment apps source directory for validation
  ansible.builtin.set_fact:
    deployment_apps_source_dir_for_validation: >-
      {{ deployment_apps_absolute_sourcedir | default(absolute_file_store_path + '/etc/' + deployment_apps_sourcedir + '/' + environment_name) }}
  when:
    - ansible_check_mode | default(false) or cca_validate_serverclass_apps | default(false)

- name: Read local serverclass data for app validation
  connection: local
  become: false
  delegate_to: localhost
  ansible.builtin.slurp:
    src: "{{ (cca_local_tmp_dir | default('/tmp/cca_tmp')) }}/{{ cca_runid }}/{{ environment_name }}/localhost/{{ inventory_hostname }}/serverclass_data_local.json"
  register: local_serverclass_data
  when:
    - ansible_check_mode | default(false) or cca_validate_serverclass_apps | default(false)
  no_log: true

- name: Validate serverclass app references against deployment-apps source directory
  connection: local
  become: false
  delegate_to: localhost
  ansible.builtin.set_fact:
    serverclass_validation_result: >-
      {{ (local_serverclass_data.content | b64decode) |
         cca_validate_serverclass_apps(deployment_apps_source_dir_for_validation | default('')) }}
  when:
    - ansible_check_mode | default(false) or cca_validate_serverclass_apps | default(false)
    - local_serverclass_data.content is defined
  no_log: true

- name: Display serverclass app validation summary
  ansible.builtin.debug:
    msg: |
      ServerClass App Validation: {{ 'PASSED' if serverclass_validation_result.valid | default(true) else 'FAILED' }}
      Referenced: {{ serverclass_validation_result.total_referenced | default(0) }} | Missing: {{ serverclass_validation_result.total_missing | default(0) }}
  when:
    - serverclass_validation_result is defined
    - ansible_check_mode | default(false) or cca_validate_serverclass_apps | default(false)

- name: Fail if serverclass references missing apps (check mode only)
  ansible.builtin.fail:
    msg: |
      ServerClass validation FAILED: {{ serverclass_validation_result.total_missing | default(0) }} missing apps detected
      Missing apps: {{ serverclass_validation_result.missing_apps | default([]) | join(', ') }}
      Source: {{ deployment_apps_source_dir_for_validation }}
  when:
    - ansible_check_mode | default(false)
    - serverclass_validation_result is defined
    - not serverclass_validation_result.valid | default(true)

- name: Warn if serverclass references missing apps (live mode with validation flag)
  ansible.builtin.debug:
    msg: |
      WARNING: ServerClass validation detected {{ serverclass_validation_result.total_missing | default(0) }} missing apps in LIVE MODE
      Missing apps: {{ serverclass_validation_result.missing_apps | default([]) | join(', ') }}
  when:
    - not ansible_check_mode | default(false)
    - cca_validate_serverclass_apps | default(false)
    - serverclass_validation_result is defined
    - not serverclass_validation_result.valid | default(true)

- name: Set remote and local base path
  ansible.builtin.set_fact:
    remote_base_path: >-
      {{ [cca_remote_tmp_dir | default('/tmp'),
         cca_runid, environment_name, hostvars['localhost']['ds_inventory_hostname']] | path_join }}
    local_base_path: >-
      {{ [cca_local_tmp_dir | default('/tmp/cca_tmp'),
         cca_runid, environment_name, 'localhost',hostvars['localhost']['ds_inventory_hostname']] | path_join }}

- name: Set intermediate variable
  ansible.builtin.set_fact:
    remote_serverclass_json: "{{ [remote_base_path, 'serverclass_data_remote.json'] | path_join }}"
    remote_duplicates_json: "{{ [remote_base_path, 'duplicates_data_remote.json'] | path_join }}"
    local_serverclass_json: "{{ [local_base_path, 'serverclass_data_remote.json'] | path_join }}"
    local_duplicates_json: "{{ [local_base_path, 'duplicates_data_remote.json'] | path_join }}"
    compare_script_path: "{{ [cca_local_tmp_dir | default('/tmp/cca_tmp'), cca_runid, environment_name, 'compare_serverclass_data.py'] | path_join }}"

- name: Run sc_parser.py on remote host
  ansible.builtin.command: >
    {{ ansible_python_interpreter }} {{ [cca_remote_tmp_dir | default('/tmp'), 'bin', 'sc_parser.py'] | path_join }}
    {{ remote_directory }}
    {{ remote_serverclass_json }}
    {{ remote_duplicates_json }}
    {{ remote_base_path }}
    "cca_merged_serverclass_*"
  register: remote_result
  changed_when: false
  check_mode: false

- name: Fetch remote serverclass data
  ansible.builtin.fetch:
    src: "{{ remote_serverclass_json }}"
    dest: "{{ local_serverclass_json }}"
    flat: true
  changed_when: false
  check_mode: false

- name: Fetch remote duplicates data
  ansible.builtin.fetch:
    src: "{{ remote_duplicates_json }}"
    dest: "{{ local_duplicates_json }}"
    flat: true
  changed_when: false
  check_mode: false

- name: Compare local and remote serverclass data
  connection: local
  become: false
  ansible.builtin.command: >
    {{ ansible_python_interpreter }} {{ compare_script_path }}
    {{ [cca_local_tmp_dir | default('/tmp/cca_tmp'), cca_runid, environment_name, 'localhost', inventory_hostname, 'serverclass_data_local.json'] | path_join }}
    {{ local_serverclass_json }}
  delegate_to: localhost
  changed_when: false
  no_log: "{{ hide_password }}"
  register: compare_serverclass_output
  check_mode: false

- name: Cleanup temporary files on remote
  ansible.builtin.file:
    path: "{{ (cca_remote_tmp_dir | default('/tmp')) }}/bin/sc_parser.py"
    state: absent
  changed_when: false
  check_mode: false

- name: Cleanup temporary JSON files on remote
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ remote_serverclass_json }}"
    - "{{ remote_duplicates_json }}"
  changed_when: false
  check_mode: false

- name: Cleanup unique directories on remote
  become: true
  ansible.builtin.file:
    path: "{{ remote_base_path }}"
    state: absent
  changed_when: false
  check_mode: false
